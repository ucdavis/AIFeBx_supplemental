---
title: "select_random_tf"
author: "Wulcan"
date: "2023-09-18"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Objective
Select a random ROI for lymphocyte level validation, fulfilling the following criteria: 
- Minimum total area: 5000 um2 
- Minimum epithelium area 1500 um2 
- Minimum lamina propria area: 1500 um2
- Minimum neither mucosa or lamina propria area: 500 um2 

#Data
slideNames.rds (a vector of slideNames) and validMucosa rmd:s (one rmd file per slide) are generated by the script mergeModels. This script relies on that all the validMucosa folder contains a file for each name in the slideNames.rds.

#Output
rois.rmd (a list of sfc polygons with coordinates for a randomly selected roi of each slide)

#Description
This script generates random rois that fulfills certain criteria. In short, an roi is generated around a random point in the epithelium and checked for fulfilling a set of criteria. If not, new points are generated until the criteria are fulfilled.

#Devitations
For some slides there is much less lamina propria then epithelium in the slide (e.g. bnaw). If an acceptable roi cannot be generated in 100 iterations, the name of the slide is saved in the list "failedSlides" and can be manually rerun with the roi generated around a random point in the lamina propria instead. 

Note that slide "96e4" in random_rois_2023-09-22 is called "9.60E05" this is because of an autocorrect error in the scanning metadata files, that was uploaded to aiforia. I have corrected the name in the output file for Aiforia (see mergeModels.rmd script) but not in the original random_rois file, since it needed to match the filename in Aiforia to be uploaded correctly.  

#Issues 
Forgot to set seed when I generated the rois for lymphocyte_level validation - i.e. won't be able to reproduce it


```{r load libraries, message = F}
library(tidyverse)
library(sf) # library for working with geojson files
library(nngeo)#this is needed for removing holes when creating tissue outline
Sys.setenv(OGR_GEOJSON_MAX_OBJ_SIZE = 1000) # increase max size of geojson files
sf_use_s2(FALSE) #disables the spherical geometry package for sf
```

### Set batch name and directories
```{r set batch name and directories}
batch <- "test_set_AIFeBx_paper"

top_dir <- "~/Library/CloudStorage/Box-Box/Projects/AI/paper/supplementary_data/" #jmwMacBook
#top_dir <- "C:/Users/jmwulcan/Box/Projects/AI/paper/supplementary_data/" #jmwDell

#Set current date
currentDate <- format(Sys.Date(), format = "%Y-%m-%d")

slideNames<-read_rds(paste0(top_dir, batch, "/output/mergeModels/all/slideNames.rds")) #modify directory

validMucosaCoords_dir <- paste0(top_dir,batch,"/output/mergeModels/by_slide/validMucosa/coordinates/")

output_dir <- paste0(top_dir, batch, "/output/randomRois/all/random_rois_", currentDate, ".rmd") #added date to this (not in original script) to not accidently overwrite original random_rois file as it cannot be recreated (see deviations)

```


```{r generate random rois}
set.seed(123) #I forgot to set this when I geenrated the ROIs used in the project, which is why this is not reproducible (see deviations above)

#Set size of roi, thresholds for criteria and max iterations

radius = 40 #determines the size of the ROI (um)
min_epi <- 1500 #minimum area of epithelium (um2)
min_lp <- 1500 #minimum area of lamina propria (um2)
max_empty <- 500 #max area that is neither lamina propria or epithelium (um2)
max_iterationsROI <- 100 #so that it doesn't run forever

iterationsSlide <- 0
failedSlides <- list()
rois <- setNames(vector("list", length(slideNames)), slideNames)

for (name in slideNames[1]){
  
  iterationsSlide <- iterationsSlide + 1
  
  
  #identifies the coordinates for the right slide in the folder of mucosa coordinates
  matching_files_validMucosa <- list.files(path = validMucosaCoords_dir, pattern = paste0("^", name))
  validMucosaPath<- file.path(validMucosaCoords_dir, matching_files_validMucosa[1])
  
  #Read in coordinates for mucosa of the slide
  validMucosaCoords <- readRDS(validMucosaPath)
  
  #Separate epithelium and lamina propria geographies into separate frames
  epiList <- validMucosaCoords %>% filter(mucosa_class_label == "Epithelium")
  lpList <- validMucosaCoords %>% filter(mucosa_class_label == "Lamina propria")
  
  #generate merged geographies epithelium and lamina propria
  epiUnited <- st_union(epiList)
  lpUnited <- st_union(lpList)
  
  #generate a random roi and test if it fulfills criteria, if not repeat
  
  iterationsROI <- 0 #to keep track
  
  # criteria
  enoughEpithelium <- FALSE
  enoughLaminaPropria <- FALSE
  notTooEmpty <- FALSE
  
  #Only conintues to iterate if criteria are not fulfilled
  while (!enoughEpithelium || !enoughLaminaPropria || !notTooEmpty){
    
    #If max iterations are reached and no roi fulfilling the criteria is identified, add it to a list of failed slides
    if (iterationsROI > max_iterationsROI) {
      failedSlides <- c(failedSlides, slide_names[[iterationsSlide]])
      break
      }
    
    iterationsROI <- iterationsROI + 1
    enoughEpithelium <- FALSE
    enoughLaminaPropria <- FALSE
    notTooEmpty <- FALSE
    
    # Generate random point and ROI 
    point <- st_sample(epiUnited, 1)
    roi <- st_buffer(point, dist = radius)
    
    # calculate areas to check
    epiIs <- st_intersection(roi, epiUnited)
    lpIs <- st_intersection(roi, lpUnited)
    areaRoi <- st_area(roi)
    areaEpi <- ifelse(length(epiIs) == 0, 0, st_area(epiIs))
    areaLp <- ifelse(length(lpIs) == 0, 0, st_area(lpIs))
    areaEmpty <- areaRoi - areaEpi - areaLp
    
    # test conditions
    if (areaEpi > min_epi) {
      enoughEpithelium <- TRUE
      }
    
    if (areaLp > min_lp) {
      enoughLaminaPropria <- TRUE
      }
    
    if (areaEmpty < max_empty) {
      notTooEmpty <- TRUE
      }
    
    #Add to list of rois if criteria are fulfilled
    if (enoughEpithelium && enoughLaminaPropria && notTooEmpty){
      rois[[iterationsSlide]] <- roi
      break
    }
  }
}


      
```
      
```{r save to Rds}
#saveRDS(rois, output_dir)
```
















  

